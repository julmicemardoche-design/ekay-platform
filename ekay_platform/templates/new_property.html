{% extends "base.html" %}

{% block title %}Ajouter un bien - E-KAY{% endblock %}

{% block extra_css %}
<style>
    .image-upload-container {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
    }
    .image-upload-container:hover {
        border-color: #0d6efd;
        background-color: #f0f7ff;
    }
    .image-upload-container i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        color: #6c757d;
    }
    .image-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    .image-preview-item {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }
    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .image-preview-item .remove-image {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .form-section {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .form-section h5 {
        color: #0d6efd;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Ajouter un nouveau bien</h2>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Retour
            </a>
        </div>
        
        <form method="POST" enctype="multipart/form-data" id="propertyForm">
            <!-- Basic Information Section -->
            <div class="form-section">
                <h5><i class="fas fa-info-circle me-2"></i>Informations de base</h5>
                
                <div class="row g-3">
                    <div class="col-md-8">
                        <label for="title" class="form-label">Titre de l'annonce *</label>
                        <input type="text" class="form-control" id="title" name="title" required 
                               placeholder="Ex: Jolie maison T2 proche du campus">
                    </div>
                    
                    <div class="col-md-4">
                        <label for="price" class="form-label">Prix mensuel (HTG) *</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="price" name="price" required 
                                   min="0" step="1000" placeholder="Ex: 50000">
                            <span class="input-group-text">HTG</span>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="address" class="form-label">Adresse complète *</label>
                        <input type="text" class="form-control" id="address" name="address" required
                               placeholder="Ex: 12 Rue des Écoles">
                    </div>
                    
                    <div class="col-md-3">
                        <label for="corridor" class="form-label">Couloir</label>
                        <input type="text" class="form-control" id="corridor" name="corridor"
                               placeholder="Ex: Couloir A">
                    </div>
                    
                    <div class="col-md-3">
                        <label for="color" class="form-label">Couleur de la maison</label>
                        <input type="text" class="form-control" id="color" name="color"
                               placeholder="Ex: Jaune">
                    </div>
                    
                    <div class="col-md-3">
                        <label for="rooms" class="form-label">Nombre de chambres *</label>
                        <select class="form-select" id="rooms" name="rooms" required>
                            <option value="">Sélectionner...</option>
                            <option value="1">1 chambre (Studio)</option>
                            <option value="2">2 chambres (T2)</option>
                            <option value="3">3 chambres (T3)</option>
                            <option value="4">4 chambres ou plus (T4+)</option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <label for="description" class="form-label">Description détaillée</label>
                        <textarea class="form-control" id="description" name="description" rows="4"
                                 placeholder="Décrivez le bien en détail (superficie, équipements, proximités, etc.)"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Images Section -->
            <div class="form-section">
                <h5><i class="fas fa-images me-2"></i>Photos du bien</h5>
                
                <div class="image-upload-container" id="imageUploadContainer">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h5>Glissez et déposez vos images ici</h5>
                    <p class="text-muted">ou cliquez pour sélectionner des fichiers</p>
                    <input type="file" id="images" name="images" multiple accept="image/*" 
                           style="display: none;" onchange="previewImages(this)">
                </div>
                
                <div class="image-preview" id="imagePreview"></div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Téléchargez jusqu'à 10 photos. La première photo sera utilisée comme photo de couverture.
                </div>
            </div>
            
            <!-- Additional Information -->
            <div class="form-section">
                <h5><i class="fas fa-list-alt me-2"></i>Informations complémentaires</h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Équipements inclus</label>
                        <div class="border rounded p-3">
                            {% for feature in ['Eau courante', 'Électricité', 'Cuisine équipée', 'Salle de bain privée', 'Climatisation', 'Ventilateur', 'Meublé', 'Internet'] %}
                            <div class="form-check form-check-inline mb-2">
                                <input class="form-check-input" type="checkbox" id="feature{{ loop.index }}" 
                                       name="features" value="{{ feature }}">
                                <label class="form-check-label" for="feature{{ loop.index }}">
                                    {{ feature }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">Règles du logement</label>
                        <div class="border rounded p-3">
                            {% for rule in ['Animaux acceptés', 'Fumeurs acceptés', 'Étudiants acceptés', 'Couples acceptés', 'Séjour long terme'] %}
                            <div class="form-check form-check-inline mb-2">
                                <input class="form-check-input" type="checkbox" id="rule{{ loop.index }}" 
                                       name="rules" value="{{ rule }}">
                                <label class="form-check-label" for="rule{{ loop.index }}">
                                    {{ rule }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Availability -->
            <div class="form-section">
                <h5><i class="fas fa-calendar-check me-2"></i>Disponibilité</h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="available_from" class="form-label">Disponible à partir du *</label>
                        <input type="date" class="form-control" id="available_from" name="available_from" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="min_stay" class="form-label">Durée minimale de location *</label>
                        <select class="form-select" id="min_stay" name="min_stay" required>
                            <option value="1">1 mois</option>
                            <option value="3">3 mois</option>
                            <option value="6">6 mois</option>
                            <option value="12" selected>1 an</option>
                            <option value="24">2 ans</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Contact Information -->
            <div class="form-section">
                <h5><i class="fas fa-phone-alt me-2"></i>Coordonnées</h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="contact_name" class="form-label">Nom du contact *</label>
                        <input type="text" class="form-control" id="contact_name" name="contact_name"
                               value="{{ current_user.username }}" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="contact_phone" class="form-label">Téléphone *</label>
                        <input type="tel" class="form-control" id="contact_phone" name="contact_phone"
                               value="{{ current_user.phone }}" required>
                    </div>
                    
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="show_phone" name="show_phone" checked>
                            <label class="form-check-label" for="show_phone">
                                Afficher mon numéro de téléphone dans l'annonce
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button type="reset" class="btn btn-outline-secondary me-md-2">
                    <i class="fas fa-undo me-2"></i>Réinitialiser
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane me-2"></i>Publier l'annonce
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Make the image upload container clickable
    document.getElementById('imageUploadContainer').addEventListener('click', function() {
        document.getElementById('images').click();
    });
    
    // Handle drag and drop
    const container = document.getElementById('imageUploadContainer');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        container.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        container.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        container.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        container.classList.add('border-primary');
        container.style.backgroundColor = '#f0f7ff';
    }
    
    function unhighlight() {
        container.classList.remove('border-primary');
        container.style.backgroundColor = '';
    }
    
    // Handle dropped files
    container.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }
    
    // Preview selected images
    function previewImages(input) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';
        
        if (input.files) {
            const files = Array.from(input.files);
            
            // Limit to 10 images
            if (files.length > 10) {
                alert('Vous ne pouvez télécharger que 10 images maximum.');
                input.value = '';
                return;
            }
            
            files.forEach((file, index) => {
                if (!file.type.match('image.*')) {
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'image-preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'remove-image';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = function() {
                        div.remove();
                        // Remove the file from the file input
                        const dt = new DataTransfer();
                        const input = document.getElementById('images');
                        const { files } = input;
                        
                        for (let i = 0; i < files.length; i++) {
                            if (index !== i) {
                                dt.items.add(files[i]);
                            }
                        }
                        
                        input.files = dt.files;
                    };
                    
                    div.appendChild(img);
                    div.appendChild(removeBtn);
                    preview.appendChild(div);
                };
                
                reader.readAsDataURL(file);
            });
        }
    }
    
    // Set minimum date for availability to today
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('available_from').min = today;
    });
</script>
{% endblock %}
